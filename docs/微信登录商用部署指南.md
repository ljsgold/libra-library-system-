# 微信登录商用部署指南

## 📋 目录

1. [资质要求](#资质要求)
2. [申请流程](#申请流程)
3. [生产环境配置](#生产环境配置)
4. [安全注意事项](#安全注意事项)
5. [部署检查清单](#部署检查清单)
6. [常见问题](#常见问题)

---

## 资质要求

### ✅ 支持的资质类型

微信开放平台的网站应用需要以下资质之一：

1. **企业资质**（推荐）
   - 需要：企业营业执照
   - 认证费用：**300元/年**
   - 适用：公司、企业法人

2. **个体工商户资质**（性价比高）
   - 需要：个体工商户营业执照
   - 认证费用：**免费**
   - 适用：个人经营者、个体工商户

3. **政府/事业单位**
   - 需要：组织机构代码证
   - 认证费用：**免费**
   - 适用：政府机构、事业单位

### ❌ 不支持的资质

- 个人身份证（无法申请网站应用）
- 测试号（仅用于开发测试，不能商用）

---

## 申请流程

### 第一步：准备材料

#### 企业资质需要：
- ✅ 企业营业执照（彩色扫描件）
- ✅ 企业对公账户信息
- ✅ 法人身份证正反面
- ✅ 联系人信息（姓名、手机、邮箱）

#### 个体工商户需要：
- ✅ 个体工商户营业执照（彩色扫描件）
- ✅ 经营者身份证正反面
- ✅ 联系人信息（姓名、手机、邮箱）

### 第二步：注册微信开放平台账号

1. **访问官网**
   - 打开：https://open.weixin.qq.com/
   - 点击右上角"注册"

2. **选择账号类型**
   - 选择"企业/个体工商户"
   - 填写基本信息（邮箱、密码等）

3. **完成邮箱验证**
   - 查收验证邮件
   - 点击邮件中的验证链接

### 第三步：账号认证

1. **进入认证页面**
   - 登录后，进入"账号中心" → "账号认证"

2. **填写认证信息**
   - 上传营业执照（彩色扫描件，JPG/PNG，大小不超过2MB）
   - 填写企业信息（名称、统一社会信用代码等）
   - 填写对公账户信息（企业）或经营者信息（个体户）
   - 填写联系人信息

3. **支付认证费用**
   - 企业：300元/年（微信支付）
   - 个体户：免费

4. **等待审核**
   - 审核时间：**1-3个工作日**
   - 审核通过后，账号状态变为"已认证"

### 第四步：创建网站应用

1. **进入管理中心**
   - 登录后，点击"管理中心"

2. **创建网站应用**
   - 点击左侧菜单"网站应用" → "创建网站应用"

3. **填写应用信息**
   ```
   应用名称：图书管理系统（或你的实际应用名称）
   应用简介：简要描述你的应用功能（50-200字）
   应用官网：https://yourdomain.com（你的网站地址）
   应用图标：上传应用图标（200x200px，PNG格式）
   ```

4. **配置授权回调域名**
   - 填写你的生产环境域名（例如：`yourdomain.com`）
   - ⚠️ **重要**：只填写域名，不包含 `http://`、`https://` 和端口号
   - ✅ 正确：`yourdomain.com`
   - ❌ 错误：`https://yourdomain.com`、`yourdomain.com:8080`

5. **提交审核**
   - 检查信息无误后，点击"提交审核"
   - 审核时间：**1-3个工作日**

### 第五步：获取 AppID 和 AppSecret

1. **查看应用详情**
   - 审核通过后，在"网站应用"列表中找到你的应用
   - 点击应用名称进入详情页

2. **获取 AppID**
   - 在"开发信息"中可以看到 **AppID**
   - 格式类似：`wx1234567890abcdef`
   - 可以直接复制

3. **获取 AppSecret**
   - 在"开发信息"中，找到 **AppSecret**
   - 点击"查看"按钮
   - 需要微信扫码验证身份
   - 验证后显示 AppSecret（类似：`abc123def456ghi789jkl012mno345pq`）
   - ⚠️ **重要**：AppSecret 只显示一次，请立即保存

4. **重置 AppSecret（如需要）**
   - 如果 AppSecret 泄露，可以点击"重置"
   - 重置后需要重新配置项目

---

## 生产环境配置

### 1. 修改配置文件

编辑 `libra-admin/src/main/resources/application.yml`：

```yaml
wechat:
  # 生产环境配置
  appid: wx你的正式appid  # 替换为审核通过的 AppID
  secret: 你的正式secret  # 替换为审核通过的 AppSecret
  redirect-uri: https://yourdomain.com/login  # 替换为你的生产环境前端登录页面地址
```

### 2. 使用环境变量（推荐）

为了安全，建议使用环境变量存储敏感信息：

#### 方式一：使用 .env 文件

创建 `.env` 文件（不要提交到 Git）：

```bash
WECHAT_APPID=wx你的正式appid
WECHAT_SECRET=你的正式secret
WECHAT_REDIRECT_URI=https://yourdomain.com/login
```

修改 `application.yml`：

```yaml
wechat:
  appid: ${WECHAT_APPID:your_appid}
  secret: ${WECHAT_SECRET:your_secret}
  redirect-uri: ${WECHAT_REDIRECT_URI:http://localhost:5173/login}
```

#### 方式二：使用系统环境变量

在服务器上设置环境变量：

```bash
export WECHAT_APPID=wx你的正式appid
export WECHAT_SECRET=你的正式secret
export WECHAT_REDIRECT_URI=https://yourdomain.com/login
```

### 3. 配置 HTTPS

⚠️ **重要**：生产环境必须使用 HTTPS

- 微信开放平台要求回调 URL 必须使用 HTTPS
- 确保你的域名已配置 SSL 证书
- 可以使用 Let's Encrypt 免费证书或购买商业证书

### 4. 配置授权回调域名

在微信开放平台的应用详情页：

1. 进入"开发信息" → "授权回调域名"
2. 点击"修改"
3. 添加生产环境域名：`yourdomain.com`
4. 保存配置

### 5. 多环境配置

如果同时需要开发和生产环境，可以使用 Spring Profile：

#### application-dev.yml（开发环境）

```yaml
wechat:
  appid: wx测试号appid
  secret: 测试号secret
  redirect-uri: http://localhost:5173/login
```

#### application-prod.yml（生产环境）

```yaml
wechat:
  appid: wx正式appid
  secret: 正式secret
  redirect-uri: https://yourdomain.com/login
```

#### 启动时指定环境

```bash
# 开发环境
java -jar app.jar --spring.profiles.active=dev

# 生产环境
java -jar app.jar --spring.profiles.active=prod
```

---

## 安全注意事项

### 🔒 1. 保护 AppSecret

- ❌ **不要**将 AppSecret 提交到 Git 仓库
- ❌ **不要**在代码中硬编码 AppSecret
- ✅ **使用**环境变量或配置文件（不提交到 Git）
- ✅ **定期**检查 AppSecret 是否泄露
- ✅ **如果泄露**，立即在微信开放平台重置 AppSecret

### 🔒 2. 使用 HTTPS

- ✅ 生产环境必须使用 HTTPS
- ✅ 确保 SSL 证书有效且未过期
- ✅ 配置 HSTS 头（可选，增强安全性）

### 🔒 3. 验证回调域名

- ✅ 确保 `redirect-uri` 的域名与微信开放平台配置的回调域名一致
- ✅ 不要使用未配置的域名
- ✅ 定期检查回调域名配置是否正确

### 🔒 4. 验证 State 参数

当前代码已实现 state 参数（时间戳），用于防止 CSRF 攻击：

```java
String state = String.valueOf(System.currentTimeMillis());
```

### 🔒 5. 错误处理

- ✅ 不要在前端暴露 AppSecret
- ✅ 不要在错误信息中暴露敏感信息
- ✅ 记录错误日志，但不要返回给用户

### 🔒 6. 访问控制

- ✅ 限制微信登录接口的访问频率（防止暴力破解）
- ✅ 使用 IP 白名单（如需要）
- ✅ 监控异常登录行为

---

## 部署检查清单

### ✅ 申请阶段

- [ ] 准备营业执照等资质材料
- [ ] 注册微信开放平台账号
- [ ] 完成账号认证（支付费用）
- [ ] 创建网站应用
- [ ] 填写应用信息并提交审核
- [ ] 等待审核通过（1-3个工作日）

### ✅ 配置阶段

- [ ] 获取 AppID 和 AppSecret
- [ ] 配置授权回调域名（生产环境域名）
- [ ] 配置项目配置文件（使用环境变量）
- [ ] 确保生产环境使用 HTTPS
- [ ] 配置 SSL 证书

### ✅ 测试阶段

- [ ] 测试微信登录 URL 生成
- [ ] 测试扫码登录流程
- [ ] 测试回调处理
- [ ] 测试用户信息获取
- [ ] 测试错误处理

### ✅ 上线前检查

- [ ] AppSecret 未提交到 Git
- [ ] 生产环境配置正确
- [ ] HTTPS 配置正确
- [ ] 回调域名配置正确
- [ ] 错误日志正常
- [ ] 监控告警配置

### ✅ 上线后监控

- [ ] 监控登录成功率
- [ ] 监控错误日志
- [ ] 监控异常访问
- [ ] 定期检查 AppSecret 安全

---

## 常见问题

### Q1: 个体工商户可以商用吗？

**A:** 可以！个体工商户资质可以正常申请网站应用，认证免费，可以用于生产环境。

### Q2: 认证费用是多少？

**A:** 
- 企业：300元/年
- 个体工商户：免费
- 政府/事业单位：免费

### Q3: 审核需要多长时间？

**A:** 
- 账号认证：1-3个工作日
- 网站应用审核：1-3个工作日
- 总计：2-6个工作日

### Q4: 可以同时配置多个回调域名吗？

**A:** 可以。在微信开放平台的"授权回调域名"中可以配置多个域名，每行一个。

### Q5: 生产环境必须使用 HTTPS 吗？

**A:** 是的。微信开放平台要求生产环境的回调 URL 必须使用 HTTPS。

### Q6: AppSecret 泄露了怎么办？

**A:** 
1. 立即登录微信开放平台
2. 进入应用详情页 → "开发信息"
3. 点击"重置 AppSecret"
4. 更新项目配置文件中的 AppSecret
5. 重启服务

### Q7: 可以同时使用测试号和正式 AppID 吗？

**A:** 可以。使用 Spring Profile 分别配置开发和生产环境：
- 开发环境：使用测试号 AppID
- 生产环境：使用正式 AppID

### Q8: 网站应用审核被拒绝了怎么办？

**A:** 
1. 查看拒绝原因（在应用详情页）
2. 根据原因修改应用信息
3. 重新提交审核
4. 常见原因：
   - 应用名称不符合规范
   - 应用简介不清晰
   - 应用官网无法访问
   - 应用图标不符合要求

### Q9: 认证到期了怎么办？

**A:** 
1. 微信开放平台会提前通知
2. 在"账号中心" → "账号认证"中续费
3. 认证到期后，应用功能会受影响
4. 建议提前续费

### Q10: 如何查看应用使用情况？

**A:** 
1. 登录微信开放平台
2. 进入"管理中心" → "网站应用"
3. 点击应用名称进入详情页
4. 查看"数据统计"（如果有）

---

## 费用总结

| 资质类型 | 认证费用 | 适用场景 |
|---------|---------|---------|
| 企业 | 300元/年 | 公司、企业法人 |
| 个体工商户 | 免费 | 个人经营者、个体工商户 |
| 政府/事业单位 | 免费 | 政府机构、事业单位 |

**注意：** 认证费用按年收取，需要每年续费。

---

## 总结

商用部署微信登录需要：

1. ✅ **资质准备**：企业或个体工商户营业执照
2. ✅ **账号认证**：在微信开放平台完成认证（企业300元/年，个体户免费）
3. ✅ **创建应用**：创建网站应用并提交审核
4. ✅ **获取凭证**：获取 AppID 和 AppSecret
5. ✅ **配置项目**：配置生产环境参数（使用环境变量）
6. ✅ **配置域名**：在微信开放平台配置授权回调域名
7. ✅ **部署上线**：确保使用 HTTPS，完成测试后上线

**预计时间：** 2-6个工作日（包括审核时间）

**预计费用：** 
- 企业：300元/年
- 个体工商户：免费

如有问题，可以：
- 查看微信开放平台文档：https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html
- 联系微信开放平台客服：95017
