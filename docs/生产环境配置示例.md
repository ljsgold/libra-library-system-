# 生产环境配置示例

## 配置文件示例

### application-prod.yml

```yaml
server:
  port: 8080

spring:
  application:
    name: libra-bms
  profiles:
    active: prod

# 微信登录配置（生产环境）
wechat:
  # 使用环境变量，不要硬编码敏感信息
  appid: ${WECHAT_APPID:your_appid}
  secret: ${WECHAT_SECRET:your_secret}
  # 生产环境必须使用 HTTPS
  redirect-uri: ${WECHAT_REDIRECT_URI:https://yourdomain.com/login}

# 其他配置...
jwt:
  secret: ${JWT_SECRET:your-jwt-secret-key}
  expiration: 86400
```

## 环境变量配置

### .env 文件（不要提交到 Git）

```bash
# 微信登录配置
WECHAT_APPID=wx你的正式appid
WECHAT_SECRET=你的正式secret
WECHAT_REDIRECT_URI=https://yourdomain.com/login

# JWT 配置
JWT_SECRET=your-strong-jwt-secret-key-here

# 数据库配置（示例）
DB_HOST=your-db-host
DB_PORT=3306
DB_NAME=libra_bms
DB_USER=your-db-user
DB_PASSWORD=your-db-password
```

### 系统环境变量（Linux/Mac）

```bash
# 编辑 ~/.bashrc 或 ~/.zshrc
export WECHAT_APPID=wx你的正式appid
export WECHAT_SECRET=你的正式secret
export WECHAT_REDIRECT_URI=https://yourdomain.com/login
export JWT_SECRET=your-strong-jwt-secret-key-here

# 使环境变量生效
source ~/.bashrc  # 或 source ~/.zshrc
```

### Docker 环境变量

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    image: libra-bms:latest
    environment:
      - WECHAT_APPID=wx你的正式appid
      - WECHAT_SECRET=你的正式secret
      - WECHAT_REDIRECT_URI=https://yourdomain.com/login
      - JWT_SECRET=your-strong-jwt-secret-key-here
    ports:
      - "8080:8080"
```

### Kubernetes 环境变量

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: libra-bms
spec:
  template:
    spec:
      containers:
      - name: app
        image: libra-bms:latest
        env:
        - name: WECHAT_APPID
          valueFrom:
            secretKeyRef:
              name: wechat-secret
              key: appid
        - name: WECHAT_SECRET
          valueFrom:
            secretKeyRef:
              name: wechat-secret
              key: secret
        - name: WECHAT_REDIRECT_URI
          value: "https://yourdomain.com/login"
```

## 启动命令

### 使用环境变量启动

```bash
# 方式一：直接设置环境变量
export WECHAT_APPID=wx你的正式appid
export WECHAT_SECRET=你的正式secret
export WECHAT_REDIRECT_URI=https://yourdomain.com/login
java -jar libra-admin.jar --spring.profiles.active=prod

# 方式二：使用 .env 文件（需要支持 .env 的启动脚本）
java -jar libra-admin.jar --spring.profiles.active=prod

# 方式三：使用 systemd（Linux）
# 编辑 /etc/systemd/system/libra-bms.service
```

### systemd 服务配置示例

```ini
# /etc/systemd/system/libra-bms.service
[Unit]
Description=Libra Book Management System
After=network.target

[Service]
Type=simple
User=libra
Environment="WECHAT_APPID=wx你的正式appid"
Environment="WECHAT_SECRET=你的正式secret"
Environment="WECHAT_REDIRECT_URI=https://yourdomain.com/login"
Environment="JWT_SECRET=your-strong-jwt-secret-key-here"
ExecStart=/usr/bin/java -jar /opt/libra-bms/libra-admin.jar --spring.profiles.active=prod
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

## 安全检查清单

- [ ] AppSecret 未硬编码在代码中
- [ ] AppSecret 使用环境变量或密钥管理服务
- [ ] `.env` 文件已添加到 `.gitignore`
- [ ] 生产环境使用 HTTPS
- [ ] SSL 证书有效且未过期
- [ ] 回调域名配置正确
- [ ] 错误日志不包含敏感信息
- [ ] 访问日志已配置
- [ ] 监控告警已配置

## 注意事项

1. **不要提交敏感信息到 Git**
   - 使用 `.gitignore` 排除 `.env` 文件
   - 使用环境变量或密钥管理服务

2. **使用 HTTPS**
   - 微信开放平台要求生产环境必须使用 HTTPS
   - 确保 SSL 证书有效

3. **定期更新 AppSecret**
   - 如果怀疑泄露，立即重置
   - 定期检查访问日志

4. **监控和告警**
   - 监控登录成功率
   - 监控错误日志
   - 设置异常访问告警
