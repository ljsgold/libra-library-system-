# 微信登录个人开发者解决方案

> 📌 **如需商用部署，请查看：[微信登录商用部署指南](./微信登录商用部署指南.md)**  
> 💼 **如果你是接外包项目的开发者，请查看：[外包开发者微信登录方案选择指南](./外包开发者微信登录方案选择指南.md)**

## 问题说明

微信开放平台的**网站应用扫码登录**功能确实需要企业资质认证，个人开发者无法直接使用。但是，个人开发者仍然有几种方式可以获得 AppID 并使用微信登录功能。

## 解决方案

### 方案一：使用企业/个体户资质（推荐，可用于商用）

如果你有**企业营业执照**或**个体工商户营业执照**，可以：

> 📖 **详细步骤请查看：[微信登录商用部署指南](./微信登录商用部署指南.md)**

**快速步骤：**

1. **注册微信开放平台账号**
   - 访问：https://open.weixin.qq.com/
   - 使用企业/个体户资质注册并完成认证
   - 认证费用：300元/年（企业），免费（个体户）

2. **创建网站应用**
   - 登录后，进入"管理中心" → "网站应用" → "创建网站应用"
   - 填写应用信息并提交审核
   - 审核通过后获得 AppID 和 AppSecret

3. **配置授权回调域名**
   - 在应用详情页面，配置"授权回调域名"
   - 例如：`localhost`（开发环境）或你的实际域名（生产环境）
   - **重要**：不需要加 `http://` 或端口号，只需要域名

4. **配置应用**
   ```yaml
   wechat:
     appid: wx你的appid
     secret: 你的secret
     redirect-uri: http://localhost:5173/login  # 前端登录页面地址
   ```

### 方案二：申请测试号（仅开发测试）

微信开放平台提供**测试号**功能，个人开发者可以申请用于开发测试：

1. **申请测试号**
   - 访问：https://open.weixin.qq.com/
   - 注册个人账号（不需要认证）
   - 申请测试号（功能有限，仅用于开发测试）

2. **注意事项**
   - 测试号**不能用于生产环境**
   - 测试号有使用限制和有效期
   - 适合开发阶段测试功能

### 方案三：使用微信公众平台（功能不同）

如果你有**微信公众号**（订阅号/服务号），可以使用**网页授权**功能：

1. **区别说明**
   - 微信开放平台：网站应用扫码登录（PC端扫码）
   - 微信公众平台：网页授权（需要用户在微信内打开）

2. **适用场景**
   - 如果你的应用主要在微信内使用，可以考虑这种方式
   - 但功能和使用场景与网站应用扫码登录不同

## 常见问题

### Q1: 为什么点击微信登录按钮后提示"请在微信客户端打开链接"？

**原因：**
1. `redirect_uri` 没有进行 URL 编码（已修复）
2. `redirect_uri` 配置错误，应该指向前端登录页面
3. 微信开放平台中配置的回调域名不正确

**解决方法：**
1. 确保 `redirect-uri` 配置为前端登录页面的完整 URL
   ```yaml
   redirect-uri: http://localhost:5173/login  # 开发环境
   redirect-uri: https://yourdomain.com/login  # 生产环境
   ```

2. 在微信开放平台配置授权回调域名时：
   - 开发环境：填写 `localhost`
   - 生产环境：填写你的域名（不含 `http://` 和端口）

3. 确保 AppID 和 AppSecret 配置正确

### Q2: 个人开发者真的无法使用吗？

**答案：** 不是的！

- **企业/个体户资质**：可以正常使用（需要认证费用）
- **个人开发者**：可以使用测试号进行开发测试，但不能用于生产环境
- **最佳实践**：如果有企业/个体户资质，建议使用正式账号；如果没有，可以先使用测试号开发，后续再申请正式账号

### Q3: 如何检查配置是否正确？

1. **检查后端配置**
   ```bash
   # 访问接口检查是否返回微信登录URL
   curl http://localhost:8080/api/auth/wechat/url
   ```

2. **检查前端**
   - 打开浏览器开发者工具
   - 查看 Network 请求，确认 `/api/auth/wechat/url` 返回了正确的 URL
   - 检查返回的 URL 中 `redirect_uri` 是否正确编码

3. **检查微信开放平台**
   - 登录微信开放平台
   - 检查应用状态是否为"已通过"
   - 检查授权回调域名是否配置正确

### Q4: redirect_uri 应该配置什么？

**答案：** 应该配置**前端登录页面的完整 URL**

- ✅ 正确：`http://localhost:5173/login`
- ✅ 正确：`https://yourdomain.com/login`
- ❌ 错误：`http://localhost:8080/auth/wechat/callback`（这是后端接口，不是前端页面）
- ❌ 错误：`/login`（缺少协议和域名）

**原因：**
- 微信回调会跳转到 `redirect_uri` 并带上 `code` 参数
- 前端登录页面会检测 URL 中的 `code` 参数
- 然后前端调用后端接口 `/api/auth/wechat/login?code=xxx` 完成登录

## 配置示例

### 开发环境配置

```yaml
wechat:
  appid: wx你的appid
  secret: 你的secret
  redirect-uri: http://localhost:5173/login
```

**微信开放平台配置：**
- 授权回调域名：`localhost`

### 生产环境配置

```yaml
wechat:
  appid: wx你的appid
  secret: 你的secret
  redirect-uri: https://yourdomain.com/login
```

**微信开放平台配置：**
- 授权回调域名：`yourdomain.com`

## 测试步骤

1. **配置 AppID 和 AppSecret**
   ```yaml
   wechat:
     appid: wx你的appid  # 替换为实际值
     secret: 你的secret  # 替换为实际值
     redirect-uri: http://localhost:5173/login
   ```

2. **重启后端服务**
   ```bash
   just start
   ```

3. **访问登录页面**
   - 打开：http://localhost:5173/login
   - 应该能看到微信登录按钮

4. **点击微信登录按钮**
   - 应该跳转到微信扫码页面
   - 使用微信扫码后，会回调到登录页面并自动完成登录

## 总结

- ✅ 个人开发者**可以**使用微信登录功能（通过企业资质或测试号）
- ✅ 已修复 `redirect_uri` 的 URL 编码问题
- ✅ 已更新配置说明和错误提示
- ✅ 前端会自动根据配置显示/隐藏微信登录按钮

如果遇到问题，请检查：
1. AppID 和 AppSecret 是否正确
2. `redirect-uri` 是否指向前端登录页面
3. 微信开放平台中的授权回调域名是否配置正确
