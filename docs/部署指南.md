# 🚀 后端部署指南（零基础版）

本指南将帮助你使用 **Railway** 免费平台部署后端服务，无需购买服务器，无需复杂配置！

## 📋 准备工作

1. **GitHub 账号**（如果没有，去 https://github.com 注册）
2. **Railway 账号**（免费注册：https://railway.app）

---

## 🎯 方案一：Railway 部署（推荐，最简单）

### 第一步：准备代码

确保你的代码已经推送到 GitHub：

```bash
# 如果还没有推送到 GitHub，执行以下命令：
git add .
git commit -m "准备部署"
git push origin main
```

### 第二步：在 Railway 创建项目

1. **访问 Railway**：https://railway.app
2. **登录/注册**：使用 GitHub 账号登录
3. **创建新项目**：
   - 点击 "New Project"
   - 选择 "Deploy from GitHub repo"
   - 选择你的仓库（libra-library-system-）

### 第三步：添加 MySQL 数据库

1. 在 Railway 项目中，点击 **"+ New"**
2. 选择 **"Database"** → **"Add MySQL"**
3. Railway 会自动创建一个 MySQL 数据库
4. **重要**：点击数据库服务，在 "Variables" 标签页中，记录以下信息：
   - `MYSQLHOST`（数据库主机）
   - `MYSQLPORT`（端口，通常是 3306）
   - `MYSQLDATABASE`（数据库名）
   - `MYSQLUSER`（用户名）
   - `MYSQLPASSWORD`（密码）

### 第四步：配置后端服务

1. 在 Railway 项目中，点击你的后端服务（应该是从 GitHub 部署的那个）
2. 点击 **"Variables"** 标签页
3. 添加以下环境变量：

```
SPRING_PROFILES_ACTIVE=mysql
SPRING_DATASOURCE_URL=jdbc:mysql://${{MySQL.MYSQLHOST}}:${{MySQL.MYSQLPORT}}/${{MySQL.MYSQLDATABASE}}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
SPRING_DATASOURCE_USERNAME=${{MySQL.MYSQLUSER}}
SPRING_DATASOURCE_PASSWORD=${{MySQL.MYSQLPASSWORD}}
JWT_SECRET=libra-bms-secret-key-libra-bms-secret-key-libra-bms
PORT=8080
```

**注意**：`${{MySQL.XXX}}` 是 Railway 的引用语法，会自动引用你刚才创建的 MySQL 服务的变量。

### 第五步：初始化数据库

1. 在 Railway 中，点击 MySQL 数据库服务
2. 点击 **"Connect"** 标签页
3. 复制 **"MySQL Command Line"** 中的连接命令
4. 在你的电脑上打开终端，执行这个命令连接到数据库
5. 执行初始化脚本：

```sql
-- 创建数据库（如果还没有）
CREATE DATABASE IF NOT EXISTS libra_bms CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE libra_bms;

-- 然后执行项目中的 db/init.sql 和 db/seed.sql
-- 你可以通过以下方式：
-- 1. 在本地执行：mysql -h [host] -u [user] -p < db/init.sql
-- 2. 或者复制 SQL 文件内容，在 MySQL 命令行中粘贴执行
```

### 第六步：获取后端 API 地址

1. 在 Railway 中，点击后端服务
2. 点击 **"Settings"** 标签页
3. 在 **"Domains"** 部分，点击 **"Generate Domain"**
4. 复制生成的域名（例如：`your-app.railway.app`）
5. **这就是你的后端 API 地址！** 完整地址是：`https://your-app.railway.app`

### 第七步：配置前端连接后端

1. 在 **Vercel** 中，进入你的前端项目
2. 打开 **Settings** → **Environment Variables**
3. 添加环境变量：
   - **Name**: `VITE_APP_BASE_API`
   - **Value**: `https://your-app.railway.app`（替换为你的 Railway 域名）
   - **Environment**: 全选（Production, Preview, Development）
4. 点击 **Save**
5. 在 Vercel Dashboard 中，点击 **"Deployments"**，找到最新的部署，点击 **"Redeploy"**

---

## 🎯 方案二：Render 部署（备选方案）

如果 Railway 不可用，可以使用 Render：

### 第一步：注册 Render

访问 https://render.com，使用 GitHub 账号登录

### 第二步：创建 Web Service

1. 点击 **"New +"** → **"Web Service"**
2. 连接你的 GitHub 仓库
3. 配置如下：
   - **Name**: libra-backend
   - **Environment**: Java
   - **Build Command**: `mvn clean package -DskipTests`
   - **Start Command**: `java -jar libra-admin/target/libra-admin.jar`
   - **Plan**: Free

### 第三步：添加 MySQL 数据库

1. 点击 **"New +"** → **"PostgreSQL"**（Render 免费版只有 PostgreSQL）
2. 或者使用外部 MySQL 服务（如 PlanetScale、Aiven 等）

### 第四步：配置环境变量

在 Web Service 的 **Environment** 标签页中添加：

```
SPRING_PROFILES_ACTIVE=mysql
SPRING_DATASOURCE_URL=jdbc:mysql://[数据库地址]:3306/libra_bms?useSSL=false&serverTimezone=UTC
SPRING_DATASOURCE_USERNAME=[用户名]
SPRING_DATASOURCE_PASSWORD=[密码]
JWT_SECRET=libra-bms-secret-key-libra-bms-secret-key-libra-bms
PORT=8080
```

---

## 🎯 方案三：本地运行 + ngrok（临时测试）

如果你只是想临时测试，可以使用 ngrok：

### 第一步：安装 ngrok

访问 https://ngrok.com，注册账号并下载 ngrok

### 第二步：启动本地后端

```bash
cd libra-admin
mvn spring-boot:run
```

### 第三步：暴露本地服务

```bash
ngrok http 8080
```

ngrok 会给你一个公网地址，例如：`https://abc123.ngrok.io`

### 第四步：配置前端

在 Vercel 环境变量中设置：
- `VITE_APP_BASE_API` = `https://abc123.ngrok.io`

**注意**：ngrok 免费版每次重启地址会变化，只适合临时测试。

---

## ✅ 验证部署

部署完成后，访问以下地址验证：

1. **后端健康检查**：`https://your-backend.railway.app/actuator/health`（如果配置了）
2. **API 文档**：`https://your-backend.railway.app/swagger-ui.html`
3. **前端应用**：你的 Vercel 地址

---

## 🔧 常见问题

### 1. 后端启动失败

- 检查环境变量是否正确配置
- 检查数据库连接信息
- 查看 Railway 的日志（Logs 标签页）

### 2. 前端无法连接后端

- 确认 `VITE_APP_BASE_API` 环境变量已设置
- 确认后端地址可以访问（在浏览器中打开）
- 检查 CORS 配置（后端需要允许前端域名访问）

### 3. 数据库连接失败

- 确认数据库服务已启动
- 检查数据库连接字符串格式
- 确认数据库已初始化（执行了 init.sql）

### 4. CORS 跨域问题

如果遇到跨域错误，需要在后端添加 CORS 配置。检查 `libra-admin/src/main/java/com/libra/admin/config/` 目录下是否有 CORS 配置类。

---

## 📞 需要帮助？

如果遇到问题，可以：
1. 查看 Railway 的日志输出
2. 检查后端启动日志
3. 在 GitHub Issues 中提问

---

## 🎉 完成！

部署完成后，你的系统架构如下：

```
前端 (Vercel) → 后端 API (Railway) → MySQL 数据库 (Railway)
```

现在你可以在任何地方访问你的图书管理系统了！
