# 微信扫码登录配置指南

## 一、注册微信开放平台账号

1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 点击右上角"注册"按钮
3. 填写注册信息并完成邮箱验证
4. 完成账号认证（需要企业资质，个人开发者无法创建网站应用）

## 二、创建网站应用

1. 登录微信开放平台后，进入 **管理中心**
2. 点击左侧菜单 **网站应用** -> **创建网站应用**
3. 填写应用信息：
   - **应用名称**：例如"图书管理系统"
   - **应用简介**：简要描述你的应用
   - **应用官网**：填写你的网站地址
   - **应用图标**：上传应用图标（建议 200x200px）
   - **授权回调域名**：填写你的域名（例如：`your-domain.com`）
     - ⚠️ **重要**：只需要填写域名，不需要带 `http://` 或 `https://`
     - ⚠️ **重要**：本地开发可以使用 `localhost`，但需要配置 hosts 文件或使用内网穿透工具

4. 提交审核（通常需要 1-3 个工作日）

## 三、获取 AppID 和 AppSecret

1. 审核通过后，在 **管理中心** -> **网站应用** 中找到你的应用
2. 点击应用名称进入详情页
3. 在 **开发信息** 中可以找到：
   - **AppID（应用ID）**：例如 `wx1234567890abcdef`
   - **AppSecret（应用密钥）**：点击"查看"按钮，需要微信扫码验证后显示

## 四、配置回调域名

1. 在应用详情页的 **开发信息** 中，找到 **授权回调域名**
2. 点击"修改"，添加你的回调域名
3. 回调域名规则：
   - 只能填写域名，不能填写完整 URL
   - 例如：`localhost` 或 `your-domain.com`
   - 不需要填写协议（http/https）和端口号

## 五、配置项目

### 1. 修改配置文件

编辑 `libra-admin/src/main/resources/application.yml`：

```yaml
wechat:
  appid: wx1234567890abcdef  # 替换为你的 AppID
  secret: your_secret_here   # 替换为你的 AppSecret
  redirect-uri: http://localhost:8080/auth/wechat/callback  # 本地开发地址
```

### 2. 本地开发配置

**方式一：使用 localhost（推荐）**
- 在微信开放平台添加回调域名：`localhost`
- 配置 `redirect-uri: http://localhost:8080/auth/wechat/callback`

**方式二：使用内网穿透（如果 localhost 无法使用）**
- 使用工具如 [ngrok](https://ngrok.com/) 或 [natapp](https://natapp.cn/)
- 获取公网地址，例如：`https://abc123.ngrok.io`
- 在微信开放平台添加回调域名：`abc123.ngrok.io`
- 配置 `redirect-uri: https://abc123.ngrok.io/auth/wechat/callback`

### 3. 生产环境配置

```yaml
wechat:
  appid: wx1234567890abcdef
  secret: your_secret_here
  redirect-uri: https://your-domain.com/auth/wechat/callback
```

在微信开放平台添加回调域名：`your-domain.com`

## 六、测试登录

1. 启动项目：`just start`
2. 访问登录页面：http://localhost:8080
3. 点击微信登录按钮
4. 应该会跳转到微信扫码登录页面
5. 使用微信扫码即可完成登录

## 常见问题

### Q1: 个人开发者可以申请吗？
**A:** 不可以。微信开放平台的网站应用需要企业资质认证，个人开发者无法创建。

### Q2: 可以使用公众号的 AppID 吗？
**A:** 不可以。公众号的 OAuth2.0 授权只能在微信客户端内使用，PC 端扫码登录必须使用微信开放平台的网站应用。

### Q3: 回调域名配置错误怎么办？
**A:** 检查以下几点：
- 回调域名只填写域名，不包含协议和端口
- 回调 URL 中的域名必须与配置的回调域名一致
- 本地开发时，确保回调域名配置为 `localhost`

### Q4: 审核需要多长时间？
**A:** 通常 1-3 个工作日，具体时间以微信开放平台通知为准。

### Q5: 测试号可以用于 PC 端扫码登录吗？
**A:** 不可以。微信测试号只能用于公众号开发，不支持网站应用扫码登录。

## 相关链接

- [微信开放平台](https://open.weixin.qq.com/)
- [网站应用开发文档](https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html)
