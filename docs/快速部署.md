# ⚡ 5分钟快速部署指南

## 🎯 目标
将后端部署到 Railway（免费），前端已部署到 Vercel。

---

## 📝 步骤概览

1. ✅ 注册 Railway 账号
2. ✅ 连接 GitHub 仓库
3. ✅ 添加 MySQL 数据库
4. ✅ 配置环境变量
5. ✅ 初始化数据库
6. ✅ 获取后端地址
7. ✅ 配置 Vercel 前端连接

---

## 🚀 详细步骤

### 1️⃣ 注册并登录 Railway

访问：https://railway.app
- 点击 "Login" → 选择 "Login with GitHub"
- 授权 Railway 访问你的 GitHub

### 2️⃣ 创建新项目

1. 点击 **"New Project"**
2. 选择 **"Deploy from GitHub repo"**
3. 找到并选择你的仓库：`libra-library-system-`
4. Railway 会自动开始部署（先不用管，后面会配置）

**💡 关于 Docker：你不需要本地安装 Docker！**

Railway 会在**云端自动**使用 Dockerfile 构建和运行你的应用。你只需要：
- ✅ 确保代码仓库中有 `Dockerfile` 文件（已存在）
- ✅ 确保 Railway 使用 Dockerfile 构建器（见下方检查步骤）

**⚠️ 重要：确保使用 Dockerfile 构建器**

如果构建失败或没有日志，请检查：
1. 点击你的服务 → **"Settings"** 标签页
2. 在 **"Build"** 部分，确认 **"Builder"** 选择的是 **"Dockerfile"**
3. 如果显示的是 "Nixpacks" 或其他，请：
   - 点击 **"Change Builder"**
   - 选择 **"Dockerfile"**
   - 确认 **"Dockerfile Path"** 是 `Dockerfile`
   - 点击 **"Save"**
4. 保存后，Railway 会自动重新部署

**📝 提示：** 项目根目录已经有 `railway.json` 配置文件，理论上 Railway 会自动识别使用 Dockerfile。但如果第一次部署时没有正确识别，请按照上述步骤手动设置。

### 3️⃣ 添加 MySQL 数据库

1. 在项目中，点击 **"+ New"** 按钮
2. 选择 **"Database"** → **"Add MySQL"**
3. 等待数据库创建完成（约 30 秒）

### 4️⃣ 配置后端环境变量

1. 点击你的后端服务（GitHub 部署的那个）
2. 点击 **"Variables"** 标签页
3. 点击 **"+ New Variable"**，逐个添加以下变量：

| 变量名 | 值 |
|--------|-----|
| `SPRING_PROFILES_ACTIVE` | `mysql` |
| `SPRING_DATASOURCE_URL` | `jdbc:mysql://${{MySQL.MYSQLHOST}}:${{MySQL.MYSQLPORT}}/${{MySQL.MYSQLDATABASE}}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC` |
| `SPRING_DATASOURCE_USERNAME` | `${{MySQL.MYSQLUSER}}` |
| `SPRING_DATASOURCE_PASSWORD` | `${{MySQL.MYSQLPASSWORD}}` |
| `JWT_SECRET` | `libra-bms-secret-key-libra-bms-secret-key-libra-bms` |
| `PORT` | `8080` |

**重要提示**：
- `${{MySQL.XXX}}` 是 Railway 的特殊语法，会自动引用 MySQL 服务的变量
- 添加完变量后，Railway 会自动重新部署

### 5️⃣ 初始化数据库

#### 方法一：使用 Railway 的 MySQL 命令行（推荐）

1. 点击 MySQL 数据库服务
2. 点击 **"Connect"** 标签页
3. 复制 **"MySQL Command Line"** 中的命令
4. 在你的电脑终端中执行这个命令
5. 连接成功后，执行：

```sql
-- 执行项目中的初始化脚本
-- 你需要先查看 db/init.sql 文件内容，然后复制粘贴执行
```

#### 方法二：使用 MySQL 客户端工具

1. 在 MySQL 服务的 **"Connect"** 标签页，找到连接信息：
   - Host
   - Port
   - Database
   - User
   - Password
2. 使用 MySQL Workbench、Navicat 等工具连接
3. 执行 `db/init.sql` 和 `db/seed.sql` 中的 SQL 语句

### 6️⃣ 获取后端 API 地址

1. 点击后端服务
2. 点击 **"Settings"** 标签页
3. 在 **"Domains"** 部分，点击 **"Generate Domain"**
4. 复制生成的域名（例如：`libra-backend-production.up.railway.app`）
5. **这就是你的后端地址！** 完整 URL：`https://libra-backend-production.up.railway.app`

### 7️⃣ 配置 Vercel 前端

1. 访问 Vercel Dashboard：https://vercel.com/dashboard
2. 进入你的项目：`libra-library-system-mga2`
3. 点击 **"Settings"** → **"Environment Variables"**
4. 添加新变量：
   - **Name**: `VITE_APP_BASE_API`
   - **Value**: 你的 Railway 后端地址（例如：`https://libra-backend-production.up.railway.app`）
   - **Environment**: 全选（Production, Preview, Development）
5. 点击 **"Save"**
6. 回到 **"Deployments"** 标签页
7. 找到最新的部署，点击 **"..."** → **"Redeploy"**

---

## ✅ 验证部署

### 检查后端

1. 访问后端 API 文档：`https://your-backend.railway.app/swagger-ui.html`
2. 如果能看到 Swagger 文档，说明后端部署成功！

### 检查前端

1. 访问你的 Vercel 前端地址
2. 尝试登录或注册
3. 如果功能正常，说明前后端连接成功！

---

## 🐛 常见问题

### ❌ 后端启动失败

**问题**：Railway 日志显示启动失败

**解决**：
1. 检查环境变量是否正确配置
2. 确认数据库连接信息（特别是 `SPRING_DATASOURCE_URL`）
3. 查看 Railway 的 Logs 标签页，找到具体错误信息

### ❌ 数据库连接失败

**问题**：后端无法连接数据库

**解决**：
1. 确认 MySQL 服务已启动（Railway 中显示为 Running）
2. 检查 `SPRING_DATASOURCE_URL` 中的变量引用是否正确
3. 确认数据库已创建（Railway 会自动创建）

### ❌ 前端 502 错误

**问题**：前端显示 502 Bad Gateway

**解决**：
1. 确认 `VITE_APP_BASE_API` 环境变量已设置
2. 确认后端地址可以访问（在浏览器中打开）
3. 确认后端服务正在运行（Railway 中显示为 Running）
4. 重新部署前端（Redeploy）

### ❌ CORS 跨域错误

**问题**：浏览器控制台显示 CORS 错误

**解决**：
- 项目已添加 CORS 配置，应该不会有这个问题
- 如果仍有问题，检查后端日志确认 CORS 配置已加载

---

## 📊 部署架构图

```
┌─────────────────┐
│   前端 (Vercel)  │
│  libra-frontend  │
└────────┬─────────┘
         │ HTTPS
         │ API 请求
         ▼
┌─────────────────┐
│  后端 (Railway)  │
│  libra-admin    │
└────────┬─────────┘
         │
         │ JDBC
         ▼
┌─────────────────┐
│ MySQL (Railway)  │
│   libra_bms      │
└─────────────────┘
```

---

## 💰 费用说明

- **Railway**：免费额度 $5/月，足够个人项目使用
- **Vercel**：免费版足够使用
- **总计**：完全免费！

---

## 🎉 完成！

恭喜！你的图书管理系统现在已经完全部署到云端了！

**下一步**：
- 测试所有功能
- 分享给你的朋友使用
- 根据需要调整配置

---

## 📞 需要帮助？

如果遇到问题：
1. 查看 Railway 的日志输出
2. 查看 Vercel 的部署日志
3. 检查浏览器控制台的错误信息

祝你部署顺利！🚀
